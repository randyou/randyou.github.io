<!-- build time:Thu Jul 09 2020 07:02:16 GMT+0000 (Coordinated Universal Time) --><!DOCTYPE html><html lang="zh"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>Gitlab + Jenkins + Harbor + k8s 实现前端持续集成与部署 | 摸鱼的蜗牛</title><meta name="description" content="CI&#x2F;CD 流程图前提环境已有 Gitlab已有 Jenkins已有 Harbor已有 K8S如果还没有以上的环境，先自行搭建。在 Harbor 中新建一个项目用来管理前端镜像新建 fe 项目进入 fe 项目，新建机器人账号保存令牌信息，将其配置到 Jenkins 中（略）准备一个 Web 项目使用 create-react-app 创建一个 React App，这里就叫 my-app步骤参考 h"><meta property="og:type" content="article"><meta property="og:title" content="Gitlab + Jenkins + Harbor + k8s 实现前端持续集成与部署"><meta property="og:url" content="http://randyou.github.io/2020/07/07/gitlab-jenkins-harbor-k8s/index.html"><meta property="og:site_name" content="摸鱼的蜗牛"><meta property="og:description" content="CI&#x2F;CD 流程图前提环境已有 Gitlab已有 Jenkins已有 Harbor已有 K8S如果还没有以上的环境，先自行搭建。在 Harbor 中新建一个项目用来管理前端镜像新建 fe 项目进入 fe 项目，新建机器人账号保存令牌信息，将其配置到 Jenkins 中（略）准备一个 Web 项目使用 create-react-app 创建一个 React App，这里就叫 my-app步骤参考 h"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://randyou.github.io/images/frontend-ci-cd-2020707.png"><meta property="og:image" content="http://randyou.github.io/images/harbor-new-fe.png"><meta property="og:image" content="http://randyou.github.io/images/harbor-fe-rotbot-acc.png"><meta property="og:image" content="http://randyou.github.io/images/harbor-fe-robot-token.png"><meta property="og:image" content="http://randyou.github.io/images/jenkins-new-pipeline.png"><meta property="og:image" content="http://randyou.github.io/images/jenkins-pipeline-conf.png"><meta property="og:image" content="http://randyou.github.io/images/harbor-image-tag.png"><meta property="og:image" content="http://randyou.github.io/images/jenkins-k8s-token.png"><meta property="og:image" content="http://randyou.github.io/images/jenkins-trigger.png"><meta property="og:image" content="http://randyou.github.io/images/gitlab-webhook.png"><meta property="article:published_time" content="2020-07-07T06:20:11.000Z"><meta property="article:modified_time" content="2020-07-09T07:01:58.506Z"><meta property="article:author" content="Randy Ou"><meta property="article:tag" content="Harbor"><meta property="article:tag" content="Docker"><meta property="article:tag" content="K8S"><meta property="article:tag" content="Jenkins"><meta property="article:tag" content="Gitlab"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://randyou.github.io/images/frontend-ci-cd-2020707.png"><link rel="canonical" href="http://randyou.github.io/2020/07/07/gitlab-jenkins-harbor-k8s/index.html"><link rel="alternate" href="/atom.xml" title="摸鱼的蜗牛" type="application/atom+xml"><link rel="icon" href="/favicon.png" type="image/x-icon"><link rel="stylesheet" href="../../../../css/style.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body class="main-center" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/randyou" target="_blank"><img class="img-circle img-rotate" src="../../../../images/avatar.png" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Randy</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">Web Developer</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Shenzhen, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="../../../../."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="../../../../archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="../../../../categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="../../../../tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li><li class="menu-item menu-item-repository"><a href="../../../../repository"><i class="icon icon-project"></i> <span class="menu-title">项目</span></a></li><li class="menu-item menu-item-links"><a href="../../../../links"><i class="icon icon-friendship"></i> <span class="menu-title">友链</span></a></li><li class="menu-item menu-item-about"><a href="../../../../about"><i class="icon icon-cup-fill"></i> <span class="menu-title">关于</span></a></li></ul><ul class="social-links"><li><a href="../../../../https:/github.com/randyou" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="../../../../atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>摸鱼提高收入！</p></div></div></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Docker/" rel="tag">Docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Dockerfile/" rel="tag">Dockerfile</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Gitlab/" rel="tag">Gitlab</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Harbor/" rel="tag">Harbor</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/Jenkins/" rel="tag">Jenkins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/K8S/" rel="tag">K8S</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/docker/" rel="tag">docker</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="../../../../tags/k8s/" rel="tag">k8s</a><span class="tag-list-count">1</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签云</h3><div class="widget-body tagcloud"><a href="../../../../tags/Docker/" style="font-size:13.5px">Docker</a> <a href="../../../../tags/Dockerfile/" style="font-size:13px">Dockerfile</a> <a href="../../../../tags/Gitlab/" style="font-size:13px">Gitlab</a> <a href="../../../../tags/Harbor/" style="font-size:14px">Harbor</a> <a href="../../../../tags/Jenkins/" style="font-size:13px">Jenkins</a> <a href="../../../../tags/K8S/" style="font-size:13px">K8S</a> <a href="../../../../tags/docker/" style="font-size:13.5px">docker</a> <a href="../../../../tags/k8s/" style="font-size:13px">k8s</a></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2020/07/">七月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="../../../../archives/2020/06/">六月 2020</a><span class="archive-list-count">4</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="" class="title">Gitlab + Jenkins + Harbor + k8s 实现前端持续集成与部署</a></p><p class="item-date"><time datetime="2020-07-07T06:20:11.000Z" itemprop="datePublished">2020-07-07</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="../../../06/16/k8s-pull-from-harbor/" class="title">k8s 从 Harbor 拉取镜像</a></p><p class="item-date"><time datetime="2020-06-16T09:36:10.000Z" itemprop="datePublished">2020-06-16</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="../../../06/16/docker-login-harbor/" class="title">docker login 登录 Harbor</a></p><p class="item-date"><time datetime="2020-06-16T07:00:20.000Z" itemprop="datePublished">2020-06-16</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="../../../06/16/harbor-install/" class="title">CentOS 7.3 安装 Harbor 镜像仓库</a></p><p class="item-date"><time datetime="2020-06-16T06:13:23.000Z" itemprop="datePublished">2020-06-16</time></p></div></li><li><div class="item-inner"><p class="item-category"></p><p class="item-title"><a href="../../../06/13/dockerfile-memo/" class="title">Dockerfile 备忘</a></p><p class="item-date"><time datetime="2020-06-13T13:29:23.000Z" itemprop="datePublished">2020-06-13</time></p></div></li></ul></div></div></div></aside><main class="main" role="main"><div class="content"><article id="post-gitlab-jenkins-harbor-k8s" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">Gitlab + Jenkins + Harbor + k8s 实现前端持续集成与部署</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="" class="article-date"><time datetime="2020-07-07T06:20:11.000Z" itemprop="datePublished">2020-07-07</time></a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="../../../../tags/Docker/" rel="tag">Docker</a>, <a class="article-tag-link" href="../../../../tags/Gitlab/" rel="tag">Gitlab</a>, <a class="article-tag-link" href="../../../../tags/Harbor/" rel="tag">Harbor</a>, <a class="article-tag-link" href="../../../../tags/Jenkins/" rel="tag">Jenkins</a>, <a class="article-tag-link" href="../../../../tags/K8S/" rel="tag">K8S</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="#comments" class="article-comment-link">评论</a></span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h2 id="CI-CD-流程图"><a href="#CI-CD-流程图" class="headerlink" title="CI/CD 流程图"></a>CI/CD 流程图</h2><p><img src="/images/frontend-ci-cd-2020707.png" alt=""></p><h2 id="前提环境"><a href="#前提环境" class="headerlink" title="前提环境"></a>前提环境</h2><ul><li>已有 Gitlab</li><li>已有 Jenkins</li><li>已有 Harbor</li><li>已有 K8S</li></ul><p>如果还没有以上的环境，先自行搭建。</p><h2 id="在-Harbor-中新建一个项目用来管理前端镜像"><a href="#在-Harbor-中新建一个项目用来管理前端镜像" class="headerlink" title="在 Harbor 中新建一个项目用来管理前端镜像"></a>在 Harbor 中新建一个项目用来管理前端镜像</h2><ol><li><p>新建 fe 项目<br><img src="/images/harbor-new-fe.png" alt=""></p></li><li><p>进入 fe 项目，新建机器人账号<br><img src="/images/harbor-fe-rotbot-acc.png" alt=""></p></li><li><p>保存令牌信息，将其配置到 Jenkins 中（略）<br><img src="/images/harbor-fe-robot-token.png" alt=""></p></li></ol><h2 id="准备一个-Web-项目"><a href="#准备一个-Web-项目" class="headerlink" title="准备一个 Web 项目"></a>准备一个 Web 项目</h2><ol><li>使用 create-react-app 创建一个 React App，这里就叫 my-app<blockquote><p>步骤参考 <a href="https://zh-hans.reactjs.org/docs/create-a-new-react-app.html#create-react-app" target="_blank" rel="noopener">https://zh-hans.reactjs.org/docs/create-a-new-react-app.html#create-react-app</a></p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npx create-react-app my-app</span><br><span class="line">cd my-app</span><br><span class="line">yarn start</span><br></pre></td></tr></table></figure><ol start="2"><li>在项目中新建文件 Nginx.conf，做为 myapp 的 Nginx 配置文件<blockquote><p>配置文件中将 api 开头的请求都代理到了后端服务，具体地址用 k8s 管理</p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># Nginx.conf</span><br><span class="line">upstream backend &#123;</span><br><span class="line">    server my-app-backend;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    server_name  _;</span><br><span class="line">    root    &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_min_length 1k;</span><br><span class="line">    gzip_comp_level 3;</span><br><span class="line">    gzip_types text&#x2F;plain application&#x2F;javascript application&#x2F;x-javascript text&#x2F;css application&#x2F;xml text&#x2F;javascript image&#x2F;jpeg image&#x2F;gif image&#x2F;png;</span><br><span class="line">    gzip_vary on;</span><br><span class="line">    gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br><span class="line"></span><br><span class="line">    location &#x2F;api&#x2F; &#123;</span><br><span class="line">        rewrite ^.+api&#x2F;?(.*)$ &#x2F;$1 break;</span><br><span class="line">        proxy_pass  http:&#x2F;&#x2F;backend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location &#x2F; &#123;</span><br><span class="line">        add_header Cache-Control no-cache;</span><br><span class="line">        try_files $uri $uri &#x2F;index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location &#x2F;static &#123;</span><br><span class="line">        add_header Cache-Control max-age&#x3D;2592000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li>新建 Dockerfile，用于构建 my-app，生成用于部署的 docker 镜像<blockquote><p>使用分阶段构建，有效使用缓存</p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># Dockerfile</span><br><span class="line">FROM node:12.17 AS builder</span><br><span class="line"></span><br><span class="line">WORKDIR &#x2F;workspace</span><br><span class="line"></span><br><span class="line">ADD yarn.lock .</span><br><span class="line">ADD package.json .</span><br><span class="line">RUN yarn</span><br><span class="line"></span><br><span class="line">ADD public public</span><br><span class="line">ADD src src</span><br><span class="line">RUN yarn run build</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FROM nginx:alpine</span><br><span class="line">COPY Nginx.conf &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;app.conf</span><br><span class="line">COPY --from&#x3D;builder &#x2F;workspace&#x2F;build &#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html&#x2F;</span><br></pre></td></tr></table></figure><ol start="4"><li>新建 Jenkinsfile，用于执行 Jenkins 流水线<blockquote><p>10.104.6.214 是 Harbor 服务 IP 地址，10.104.6.215:32567 是 k8s 服务地址，请自行修改为自己的 IP 地址<br>使用 package.json 中的 name 字段作为 k8s 命名空间名和容器名<br>imageName 是镜像的 tag，这里会将镜像上传到 Harbor 的 fe 项目下<br>robot_jenkins-test 是上面创建的 Harbor 机器人账号在 Jenkins 中的配置 ID</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pipeline&#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123;</span><br><span class="line">        branchName &#x3D; sh(returnStdout: true, script: &quot;echo $&#123;GIT_BRANCH&#125; | sed &#39;s&#x2F;origin\\&#x2F;&#x2F;&#x2F;g&#39;&quot;).trim()</span><br><span class="line">        pkgInfo &#x3D; readJSON file: &#39;package.json&#39;</span><br><span class="line">        pkgName &#x3D; &quot;$&#123;pkgInfo.name&#125;&quot;</span><br><span class="line">        commitId &#x3D; sh(returnStdout: true, script: &#39;git rev-parse --short HEAD&#39;).trim()</span><br><span class="line">        imageTag &#x3D; &quot;$&#123;branchName&#125;-$&#123;commitId&#125;&quot;</span><br><span class="line">        imageName &#x3D; &quot;10.104.6.214&#x2F;fe&#x2F;$&#123;pkgName&#125;:$&#123;imageTag&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    stages&#123;</span><br><span class="line">        stage(&quot;Build Image&quot;)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                retry(3)&#123;</span><br><span class="line">                    script&#123;</span><br><span class="line">                        appImage &#x3D; docker.build(&quot;$&#123;imageName&#125;&quot;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&quot;Push Image&quot;)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                retry(3)&#123;</span><br><span class="line">                    script&#123;</span><br><span class="line">                        docker.withRegistry(&#39;http:&#x2F;&#x2F;10.104.6.214&#x2F;v2&#39;, &#39;robot_jenkins-test&#39;) &#123;</span><br><span class="line">                            appImage.push()</span><br><span class="line">                            appImage.push(&#39;latest&#39;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>将 my-app 提交后推到 Gitlab 上</li></ol><h2 id="配置-Jenkins"><a href="#配置-Jenkins" class="headerlink" title="配置 Jenkins"></a>配置 Jenkins</h2><ol><li><p>登录 Jenkins 服务，新建任务，新建一个流水线<br><img src="/images/jenkins-new-pipeline.png" alt=""></p></li><li><p>配置流水线<br><img src="/images/jenkins-pipeline-conf.png" alt=""></p></li></ol><blockquote><p>保存后点击立即构建，测试流水线。流水线将构建出一个镜像并推送到 Harbor。</p></blockquote><h2 id="配置-k8s"><a href="#配置-k8s" class="headerlink" title="配置 k8s"></a>配置 k8s</h2><ol><li><p>创建 my-app 命名空间用于部署 my-app</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create namespace my-app</span><br></pre></td></tr></table></figure></li><li><p>使用 deployment.yaml 部署 my-app</p><blockquote><p>查看 Harbor 的 fe 项目中 my-app 镜像的 tag 为 master-673d670<br><img src="/images/harbor-image-tag.png" alt=""></p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#  deployment.yaml</span><br><span class="line">apiVersion: apps&#x2F;v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app   # 部署名称</span><br><span class="line">  namespace: my-app       # 部署到的命名空间</span><br><span class="line">  labels:</span><br><span class="line">    app: my-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: my-app</span><br><span class="line">      labels:</span><br><span class="line">        app: my-app</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - name: my-app</span><br><span class="line">          image: 10.104.6.214&#x2F;fe&#x2F;my-app:master-673d670</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          ports:</span><br><span class="line">            - name: http-port</span><br><span class="line">              containerPort: 80</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">        - name: harbor-test-fe</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: my-app</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure><blockquote><p>harbor-test-fe 是拉取镜像所需要的令牌信息，具体配置可参考 <a href="/2020/06/16/k8s-pull-from-harbor/" title="k8s 从 Harbor 拉取镜像">k8s 从 Harbor 拉取镜像</a></p></blockquote><p>查看 pod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods -l app&#x3D;my-app -n my-app</span><br></pre></td></tr></table></figure><p>此时 pod 已经部署成功，但是 Ready 一直是 Fasle，查看容器日志发现以下报错</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host not found in upstream &quot;my-app-backend&quot; in &#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;app.conf:2</span><br></pre></td></tr></table></figure><p>是因为没有配置 my-app-backend 的 DNS。</p><ol start="3"><li>配置后端服务地址 my-app-backend<blockquote><p>这里假设后端服务没有部署在 k8s 集群上，而是部署在 IP 地址为 192.16.100.56 的服务器上，端口为 26003</p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># service.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app-backend</span><br><span class="line">  namespace: my-app</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      targetPort: 26003</span><br><span class="line">      </span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Endpoints</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app-backend</span><br><span class="line">subsets:</span><br><span class="line">  - addresses:</span><br><span class="line">      - ip: 192.16.100.56</span><br><span class="line">    ports:</span><br><span class="line">      - port: 26003</span><br></pre></td></tr></table></figure><p>部署 service</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f service.yaml</span><br></pre></td></tr></table></figure><p>删除 pod</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pods my-app-ddc88c8f9-xzcl7 -n my-app</span><br></pre></td></tr></table></figure><p>此时 pod 已经成功运行</p><h2 id="暴露-Web-服务"><a href="#暴露-Web-服务" class="headerlink" title="暴露 Web 服务"></a>暴露 Web 服务</h2><ol><li>为 my-app 创建 service<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl expose deployment&#x2F;my-app -n my-app</span><br></pre></td></tr></table></figure></li><li>配置 ingress 规则<blockquote><p>my-app.com 是域名，如果没有正式域名，修改本机的 hosts 访问即可</p></blockquote></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># ingress.yaml</span><br><span class="line">apiVersion: networking.k8s.io&#x2F;v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: my-app</span><br><span class="line">  namespace: my-app</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">    - host: my-app.com</span><br><span class="line">      http:</span><br><span class="line">        paths:</span><br><span class="line">          - backend:</span><br><span class="line">              serviceName: my-app</span><br><span class="line">              servicePort: 80</span><br><span class="line">            path: &#x2F;</span><br><span class="line">            pathType: ImplementationSpecific</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f ingress.yaml</span><br></pre></td></tr></table></figure><h2 id="Jenkins-自动化部署"><a href="#Jenkins-自动化部署" class="headerlink" title="Jenkins 自动化部署"></a>Jenkins 自动化部署</h2><ol><li>在 kube-system 下创建一个 ServiceAccount</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># serviceAccount.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io&#x2F;v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: jenkins-user</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f serviceAccount.yaml</span><br></pre></td></tr></table></figure><ol start="2"><li><p>查看刚刚创建的 ServiceAccont 的 token</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep jenkins-user | awk &#39;&#123;print $1&#125;&#39;)</span><br></pre></td></tr></table></figure></li><li><p>在 Jenkins 增加一个 ID 为 k8s-test-token 的凭据<br><img src="/images/jenkins-k8s-token.png" alt=""></p></li><li><p>修改 Jeninsfile</p></li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">pipeline&#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123;</span><br><span class="line">        branchName &#x3D; sh(returnStdout: true, script: &quot;echo $&#123;GIT_BRANCH&#125; | sed &#39;s&#x2F;origin\\&#x2F;&#x2F;&#x2F;g&#39;&quot;).trim()</span><br><span class="line">        pkgInfo &#x3D; readJSON file: &#39;package.json&#39;</span><br><span class="line">        pkgName &#x3D; &quot;$&#123;pkgInfo.name&#125;&quot;</span><br><span class="line">        commitId &#x3D; sh(returnStdout: true, script: &#39;git rev-parse --short HEAD&#39;).trim()</span><br><span class="line">        imageTag &#x3D; &quot;$&#123;branchName&#125;-$&#123;commitId&#125;&quot;</span><br><span class="line">        imageName &#x3D; &quot;10.104.6.214&#x2F;fe&#x2F;$&#123;pkgName&#125;:$&#123;imageTag&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    stages&#123;</span><br><span class="line">        stage(&quot;Build Image&quot;)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                retry(3)&#123;</span><br><span class="line">                    script&#123;</span><br><span class="line">                        appImage &#x3D; docker.build(&quot;$&#123;imageName&#125;&quot;)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&quot;Push Image&quot;)&#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                retry(3)&#123;</span><br><span class="line">                    script&#123;</span><br><span class="line">                        docker.withRegistry(&#39;http:&#x2F;&#x2F;10.104.6.214&#x2F;v2&#39;, &#39;robot_jenkins-test&#39;) &#123;</span><br><span class="line">                            appImage.push()</span><br><span class="line">                            appImage.push(&#39;latest&#39;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&quot;Deploy Test&quot;)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                withCredentials([string(credentialsId: &#39;k8s-test-token&#39;, variable: &#39;k8s_test_token&#39;)]) &#123;</span><br><span class="line">                    retry(3)&#123; </span><br><span class="line">                        sh &quot;curl -X PATCH \</span><br><span class="line">                                 -H \&quot;content-type: application&#x2F;strategic-merge-patch+json\&quot; \</span><br><span class="line">                                 -H \&quot;Authorization:Bearer $k8s_test_token\&quot; \</span><br><span class="line">                                 -d &#39;&#123;\&quot;spec\&quot;:&#123;\&quot;template\&quot;:&#123;\&quot;spec\&quot;:&#123;\&quot;containers\&quot;:[&#123;\&quot;name\&quot;:\&quot;$&#123;pkgName&#125;\&quot;,\&quot;image\&quot;:\&quot;$&#123;imageName&#125;\&quot;&#125;]&#125;&#125;&#125;&#125;&#39; \</span><br><span class="line">                                    \&quot;http:&#x2F;&#x2F;10.104.6.215:32567&#x2F;k8s-api&#x2F;apis&#x2F;apps&#x2F;v1&#x2F;namespaces&#x2F;$&#123;pkgName&#125;&#x2F;deployments&#x2F;$&#123;pkgName&#125;\&quot;&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#39;Deploy Production&#39;) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                environment name: &#39;branchName&#39;, value: &#39;master&#39;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                script &#123;</span><br><span class="line">                    timeout(time: 15, unit: &#39;MINUTES&#39;) &#123;</span><br><span class="line">                        input message: &#39;立即部署到生产环境？&#39;, ok: &#39;确认部署生产环境&#39;</span><br><span class="line">                    &#125;</span><br><span class="line">                    retry(3) &#123;</span><br><span class="line">                        echo &#39;Deploying Production&#39;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>Gitlab 自动触发<br><img src="/images/jenkins-trigger.png" alt=""><br><img src="/images/gitlab-webhook.png" alt=""></li></ol><blockquote><p>提交代码到 Gitlab 后将自动触发构建部署</p></blockquote></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="http://randyou.github.io/2020/07/07/gitlab-jenkins-harbor-k8s/" title="Gitlab + Jenkins + Harbor + k8s 实现前端持续集成与部署" target="_blank" rel="external">http://randyou.github.io/2020/07/07/gitlab-jenkins-harbor-k8s/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/randyou" target="_blank" class="img-burn thumb-sm visible-lg"><img src="../../../../images/avatar.png" class="img-rounded w-full" alt=""></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/randyou" target="_blank"><span class="text-dark">Randy</span><small class="ml-1x">Web Developer</small></a></h3><div>前端开发工程师。</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="next"><a href="../../../06/16/k8s-pull-from-harbor/" title="k8s 从 Harbor 拉取镜像"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li></ul><div class="bar-right"><div class="share-component" data-sites="wechat,weibo,qq,qzone,facebook,twitter" data-mobile-sites="wechat,weibo,qq,qzone"></div></div></div></nav></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="../../../../https:/github.com/randyou" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="../../../../atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="../../../../js/plugin.min.js"></script><script src="../../../../js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"../../../../content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="../../../../js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script><script src="//cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script type="text/javascript">var gitalk=new Gitalk({clientID:"2d1122f47b28e73b1ccc",clientSecret:"c608987e73e9a32928c8fba54185c072a871b402",repo:"randyou.github.io",owner:"randyou",admin:["randyou"],id:md5(location.pathname),distractionFreeMode:!0});gitalk.render("comments")</script></body></html><!-- rebuild by neat -->